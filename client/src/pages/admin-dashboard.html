<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UrbanEcho | Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .severity-high { background-color: #f87171; color: white; }
        .severity-medium { background-color: #fbbf24; color: black; }
        .severity-low { background-color: #60a5fa; color: white; }
        /* Tab Active State */
        .tab-active {
            background-color: #2563eb; 
            color: white;
            border-color: #2563eb;
        }
        .tab-inactive {
            background-color: white;
            color: #4b5563;
            border-color: #e5e7eb;
        }
        .tab-inactive:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">
    <div class="relative z-10 pt-8 px-6 max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-end mb-6">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800">Admin Panel üõ†Ô∏è</h1>
                <p class="text-gray-500 mt-1">Manage issues by department.</p>
            </div>
            <div class="flex items-center gap-4">
                <button id="runSummarizerBtn" class="bg-purple-600 text-white py-2 px-4 rounded-lg shadow hover:bg-purple-700 transition font-medium flex items-center gap-2">
                    <span>Run AI Summarizer</span> ü§ñ
                </button>
                <button id="refreshBtn" onclick="loadAdminData()" class="text-sm text-blue-600 hover:underline">
                    Refresh Data ‚ü≥
                </button>
            </div>
        </div>

        <!-- Department Tabs -->
        <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-200 pb-4">
            <button onclick="switchTab('all')" id="tab-all" class="tab-active px-4 py-2 rounded-full border text-sm font-bold transition">All</button>
            <button onclick="switchTab('road')" id="tab-road" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Road</button>
            <button onclick="switchTab('light')" id="tab-light" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Lights</button>
            <button onclick="switchTab('water')" id="tab-water" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Water</button>
            <button onclick="switchTab('electricity')" id="tab-electricity" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Electricity</button>
            <button onclick="switchTab('sanitation')" id="tab-sanitation" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Sanitation</button>
            <button onclick="switchTab('traffic')" id="tab-traffic" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Traffic</button>
            <button onclick="switchTab('drainage')" id="tab-drainage" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Drainage</button>
            <button onclick="switchTab('garbage')" id="tab-garbage" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Garbage</button>
            <button onclick="switchTab('others')" id="tab-others" class="tab-inactive px-4 py-2 rounded-full border text-sm font-bold transition">Others</button>
        </div>
        
        <!-- Table Container -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-700" id="tableTitle">All Complaints</h2>
                <span class="text-xs font-mono bg-gray-200 text-gray-600 px-2 py-1 rounded" id="countBadge">0 items</span>
            </div>

            <table class="w-full text-sm text-left">
                <thead class="bg-gray-100 text-gray-700">
                    <tr>
                        <th class="p-4">ID</th>
                        <th class="p-4">Location</th>
                        <th class="p-4">Title</th>
                        <th class="p-4">Department</th> <!-- Added Dept Column -->
                        <th class="p-4">Severity</th>
                        <th class="p-4">Status</th>
                        <th class="p-4 w-1/5">Action</th>
                    </tr>
                </thead>
                <tbody id="adminComplaintsBody">
                    <!-- Rows injected via JS -->
                </tbody>
            </table>
        </div>
    </div>

<script>
    const API_BASE = 'http://localhost:5000/api/admin';
    let allComplaintsData = []; // Global store for data
    let currentTab = 'all';

    const getStatusColor = (status) => {
        const map = {
            'Pending': 'text-yellow-600 bg-yellow-50',
            'In Progress': 'text-blue-600 bg-blue-50',
            'Resolved': 'text-green-600 bg-green-50',
            'Rejected': 'text-red-600 bg-red-50'
        };
        return map[status] || 'text-gray-500';
    };

    // --- 1. SWITCH TAB LOGIC ---
    window.switchTab = (category) => {
        currentTab = category;

        // Update UI Buttons
        document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
            if(btn.id === `tab-${category}`) {
                btn.classList.remove('tab-inactive');
                btn.classList.add('tab-active');
            } else {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            }
        });

        // Filter Data
        const filtered = category === 'all' 
            ? allComplaintsData 
            : allComplaintsData.filter(item => item.department === category);

        // Update Title
        document.getElementById('tableTitle').innerText = category === 'all' ? "All Complaints" : `${category.charAt(0).toUpperCase() + category.slice(1)} Complaints`;
        document.getElementById('countBadge').innerText = `${filtered.length} items`;

        renderAdminTable(filtered);
    };

    // --- 2. RENDER TABLE ---
    const renderAdminTable = (data) => {
        const tableBody = document.getElementById("adminComplaintsBody");
        tableBody.innerHTML = ""; 

        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400 italic">No complaints found in this category.</td></tr>`;
            return;
        }

        data.forEach(item => {
            const statusClass = getStatusColor(item.current_status);
            
            // Safely handle null locations
            const locDisplay = item.location ? item.location : "Unknown Loc";
            
            const row = `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="p-4 font-mono text-xs text-gray-500">#${item.summary_id}</td>
                    <td class="p-4 font-medium text-gray-600">${locDisplay}</td>
                    <td class="p-4 font-bold text-gray-800">${item.summary_title}</td>
                    <td class="p-4"><span class="text-xs uppercase tracking-wider font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">${item.department}</span></td>
                    <td class="p-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded ${'severity-' + item.severity.toLowerCase()}">
                            ${item.severity}
                        </span>
                    </td>
                    <td class="p-4">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">${item.current_status}</span>
                    </td>
                    <td class="p-4">
                        <select onchange="updateStatus(${item.summary_id}, '${item.department}', this.value)" 
                                class="border border-gray-300 p-1.5 rounded text-sm bg-white hover:border-blue-500 focus:ring-2 focus:ring-blue-200 cursor-pointer outline-none transition">
                            <option value="" disabled selected>Update</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Pending">Pending</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    };

    // --- 3. UPDATE STATUS (API) ---
    window.updateStatus = async (id, department, newStatus) => {
        if (!confirm(`Update #${id} (${department}) to "${newStatus}"?`)) return;

        try {
            const response = await fetch(`${API_BASE}/status/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newStatus, department })
            });

            if (response.ok) {
                // Optimistic UI Update (Update local data without re-fetching)
                const index = allComplaintsData.findIndex(d => d.summary_id === id && d.department === department);
                if(index !== -1) {
                    allComplaintsData[index].current_status = newStatus;
                    switchTab(currentTab); // Re-render current tab
                }
            } else {
                alert('Update failed.');
            }
        } catch (error) {
            console.error(error);
            alert('Server Error');
        }
    };

    // --- 4. AI SUMMARIZER LOGIC ---
    document.getElementById('runSummarizerBtn').addEventListener('click', async () => {
        if (!confirm("This will fetch all unresolved user complaints and run the AI grouping/summarization process. Continue?")) {
            return;
        }
        
        const btn = document.getElementById('runSummarizerBtn');
        const originalText = btn.innerHTML; // Save the icon
        btn.innerText = "Processing...";
        btn.disabled = true;
        btn.classList.add("opacity-50", "cursor-not-allowed");

        try {
            const response = await fetch(`${API_BASE}/summarize`, { method: 'POST' });
            const result = await response.json();
            alert(result.message);
            loadAdminData(); // Reload table to see changes
        } catch (error) {
            console.error(error);
            alert("Error running AI service. Check if backend/Python script is running.");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.classList.remove("opacity-50", "cursor-not-allowed");
        }
    });
    
    // --- 5. INITIAL LOAD ---
    window.loadAdminData = async () => {
        try {
            const response = await fetch(`${API_BASE}/dashboard`);
            if (!response.ok) throw new Error("Failed");
            allComplaintsData = await response.json();
            switchTab(currentTab); // Reload current view
        } catch (error) {
            document.getElementById("adminComplaintsBody").innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-500">Error loading dashboard data. Ensure backend is running.</td></tr>`;
        }
    };
    
    window.onload = loadAdminData;
</script>
</body>
</html>